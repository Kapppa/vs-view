name: Publish Python Package

on:
  workflow_call:
    inputs:
      tag:
        description: "Tag prefix for this package (e.g., 'vsview', 'split-planes')"
        required: true
        type: string
      package:
        description: "PyPI package name"
        required: true
        type: string
      path:
        description: "Path to the package directory"
        required: true
        type: string
      python-version:
        description: "Python version to use"
        required: false
        type: string
        default: "3.14"
    secrets:
      WEBHOOK_URL:
        required: false

jobs:
  build:
    name: Build and publish ${{ inputs.package }}
    runs-on: ubuntu-latest

    # This condition works because inputs.* IS available at job level in reusable workflows
    if: >-
      github.event_name == 'workflow_dispatch' && github.event.inputs.package == inputs.tag ||
      github.event_name == 'push' && startsWith(github.ref, format('refs/tags/{0}/v', inputs.tag))

    environment:
      name: pypi
      url: https://pypi.org/p/${{ inputs.package }}

    env:
      WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}

    permissions:
      contents: write
      id-token: write

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ inputs.python-version }}
          enable-cache: true

      - name: Build
        working-directory: ${{ inputs.path }}
        run: uvx hatch build

      - name: Check the output
        working-directory: ${{ inputs.path }}
        run: uvx twine check --strict dist/*

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: ${{ inputs.path }}/dist

      - name: Post webhook for failure
        if: failure() && env.WEBHOOK_URL != ''
        uses: Jaded-Encoding-Thaumaturgy/discord-failure-notifier@v1
        with:
          webhook-url: ${{ env.WEBHOOK_URL }}
